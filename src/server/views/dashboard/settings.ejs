<!-- Header -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
    <h1 class="section-title !mb-0">Bot Settings</h1>
    <button onclick="saveAllSettings()" class="btn-primary">
        <i data-lucide="check-circle" class="w-4 h-4"></i>
        <span>Save All Changes</span>
    </button>
</div>

<!-- Settings Tabs -->
<div class="card !p-0 overflow-hidden">
    <!-- Tab Headers -->
    <div class="border-b border-[rgb(var(--color-border))]">
        <nav class="flex space-x-8 px-6 overflow-x-auto" aria-label="Tabs">
            <button onclick="switchTab('general')" id="tab-general" class="tab-button active whitespace-nowrap">
                <i data-lucide="settings" class="w-4 h-4"></i>
                <span>General</span>
            </button>
            <button onclick="switchTab('connection')" id="tab-connection" class="tab-button whitespace-nowrap">
                <i data-lucide="wifi" class="w-4 h-4"></i>
                <span>Connection</span>
            </button>
            <button onclick="switchTab('commands')" id="tab-commands" class="tab-button whitespace-nowrap">
                <i data-lucide="terminal" class="w-4 h-4"></i>
                <span>Commands</span>
            </button>
            <button onclick="switchTab('security')" id="tab-security" class="tab-button whitespace-nowrap">
                <i data-lucide="shield-check" class="w-4 h-4"></i>
                <span>Security</span>
            </button>
            <button onclick="switchTab('advanced')" id="tab-advanced" class="tab-button whitespace-nowrap">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                <span>Advanced</span>
            </button>
        </nav>
    </div>

    <!-- Tab Content -->
    <div class="p-6">
        <!-- General Settings -->
        <div id="content-general" class="tab-content">
            <form id="generalForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="botName" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Bot Name</label>
                        <input type="text" id="botName" value="<%= config.BOT_NAME || 'AkaneBot' %>"
                               class="input-field">
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">The display name for your bot</p>
                    </div>
                    
                    <div>
                        <label for="prefix" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Command Prefix</label>
                        <input type="text" id="prefix" value="<%= config.PREFIX || '!' %>" maxlength="3"
                               class="input-field">
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Character(s) that trigger commands</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="logLevel" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Log Level</label>
                        <select id="logLevel" class="input-field">
                            <option value="error" <%= config.LOG_LEVEL === 'error' ? 'selected' : '' %>>Error</option>
                            <option value="warn" <%= config.LOG_LEVEL === 'warn' ? 'selected' : '' %>>Warning</option>
                            <option value="info" <%= config.LOG_LEVEL === 'info' ? 'selected' : '' %>>Info</option>
                            <option value="debug" <%= config.LOG_LEVEL === 'debug' ? 'selected' : '' %>>Debug</option>
                        </select>
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Level of detail in console logs</p>
                    </div>
                    
                    <div>
                        <label for="commandsDir" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Commands Directory</label>
                        <input type="text" id="commandsDir" value="<%= config.COMMANDS_DIR || 'src/commands' %>"
                               class="input-field">
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Directory containing bot commands</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="autoReconnect" <%= config.AUTO_RECONNECT === 'true' ? 'checked' : '' %>
                           class="w-4 h-4 text-blue-500 bg-[rgb(var(--color-bg-primary))] border-[rgb(var(--color-border))] rounded focus:ring-blue-500 focus:ring-2">
                    <div>
                        <label for="autoReconnect" class="text-sm font-medium text-[rgb(var(--color-text-primary))]">Auto Reconnect</label>
                        <p class="text-xs text-[rgb(var(--color-text-secondary))]">Automatically reconnect when connection is lost</p>
                    </div>
                </div>
            </form>
        </div>

        <!-- Connection Settings -->
        <div id="content-connection" class="tab-content hidden">
            <form id="connectionForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="printQR" <%= config.PRINT_QR === 'true' ? 'checked' : '' %>
                               class="w-4 h-4 text-blue-500 bg-[rgb(var(--color-bg-primary))] border-[rgb(var(--color-border))] rounded focus:ring-blue-500 focus:ring-2">
                        <div>
                            <label for="printQR" class="text-sm font-medium text-[rgb(var(--color-text-primary))]">Print QR Code to Console</label>
                            <p class="text-xs text-[rgb(var(--color-text-secondary))]">Display QR code in terminal for scanning</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="usePairingCode" <%= config.USE_PAIRING_CODE === 'true' ? 'checked' : '' %>
                               class="w-4 h-4 text-blue-500 bg-[rgb(var(--color-bg-primary))] border-[rgb(var(--color-border))] rounded focus:ring-blue-500 focus:ring-2">
                        <div>
                            <label for="usePairingCode" class="text-sm font-medium text-[rgb(var(--color-text-primary))]">Use Pairing Code</label>
                            <p class="text-xs text-[rgb(var(--color-text-secondary))]">Use pairing code instead of QR code</p>
                        </div>
                    </div>
                </div>
                
                <div id="pairingNumberField" style="display: <%= config.USE_PAIRING_CODE === 'true' ? 'block' : 'none' %>;">
                    <label for="pairingNumber" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Pairing Phone Number</label>
                    <input type="text" id="pairingNumber" value="<%= config.PAIRING_NUMBER || '' %>" 
                           placeholder="628123456789"
                           class="input-field">
                    <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Phone number for pairing code (without +)</p>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                        <div>
                            <p class="font-medium text-blue-300">Connection Status:</p>
                            <div id="connectionStatus" class="text-sm text-[rgb(var(--color-text-secondary))]">
                                <div class="inline-flex items-center space-x-2">
                                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-400 border-t-transparent"></div>
                                    <span>Checking...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Commands Settings -->
        <div id="content-commands" class="tab-content hidden">
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-[rgb(var(--color-text-primary))]">Command Categories</h3>
                    <button onclick="reloadCommands()" class="btn-secondary">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Reload Commands</span>
                    </button>
                </div>
                
                <div id="commandCategories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-[rgb(var(--color-bg-primary))] border border-green-500 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="text-[rgb(var(--color-text-primary))] font-medium">General Commands</h4>
                                <p class="text-[rgb(var(--color-text-secondary))] text-sm">Basic bot commands</p>
                            </div>
                            <span class="px-2 py-1 bg-green-500 text-white text-xs font-semibold rounded">Active</span>
                        </div>
                        <div class="text-xs text-[rgb(var(--color-text-secondary))]">5 commands loaded</div>
                    </div>
                    
                    <div class="bg-[rgb(var(--color-bg-primary))] border border-green-500 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="text-[rgb(var(--color-text-primary))] font-medium">Media Commands</h4>
                                <p class="text-[rgb(var(--color-text-secondary))] text-sm">Image and video tools</p>
                            </div>
                            <span class="px-2 py-1 bg-green-500 text-white text-xs font-semibold rounded">Active</span>
                        </div>
                        <div class="text-xs text-[rgb(var(--color-text-secondary))]">4 commands loaded</div>
                    </div>
                    
                    <div class="bg-[rgb(var(--color-bg-primary))] border border-green-500 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="text-[rgb(var(--color-text-primary))] font-medium">Utility Commands</h4>
                                <p class="text-[rgb(var(--color-text-secondary))] text-sm">Helpful utilities</p>
                            </div>
                            <span class="px-2 py-1 bg-green-500 text-white text-xs font-semibold rounded">Active</span>
                        </div>
                        <div class="text-xs text-[rgb(var(--color-text-secondary))]">6 commands loaded</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div id="content-security" class="tab-content hidden">
            <form id="securityForm" class="space-y-6">
                <div>
                    <label for="ownerNumbers" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Owner Numbers</label>
                    <textarea id="ownerNumbers" rows="3" 
                              class="input-field resize-none"
                              placeholder="628123456789,628987654321"><%= config.OWNER_NUMBERS || '' %></textarea>
                    <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Comma-separated list of phone numbers with full bot access</p>
                </div>
                
                <div>
                    <label for="adminNumbers" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Admin Numbers</label>
                    <textarea id="adminNumbers" rows="3" 
                              class="input-field resize-none"
                              placeholder="628111111111,628222222222"><%= config.ADMIN_NUMBERS || '' %></textarea>
                    <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Comma-separated list of phone numbers with admin privileges</p>
                </div>
                
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                    <div class="flex items-start space-x-2">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                        <div>
                            <p class="font-medium text-yellow-300 mb-1">Security Notice</p>
                            <p class="text-sm text-[rgb(var(--color-text-secondary))]">
                                Be careful when adding phone numbers. Owner and admin users have elevated permissions.
                            </p>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Settings -->
        <div id="content-advanced" class="tab-content hidden">
            <form id="advancedForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="dbMode" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Database Mode</label>
                        <select id="dbMode" class="input-field">
                            <option value="json" <%= config.DB_MODE === 'json' ? 'selected' : '' %>>JSON File</option>
                            <option value="mongodb" <%= config.DB_MODE === 'mongodb' ? 'selected' : '' %>>MongoDB</option>
                            <option value="sqlite" <%= config.DB_MODE === 'sqlite' ? 'selected' : '' %>>SQLite</option>
                        </select>
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Storage method for bot data</p>
                    </div>
                    
                    <div>
                        <label for="dbPath" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">Database Path</label>
                        <input type="text" id="dbPath" value="<%= config.DB_PATH || './data' %>"
                               class="input-field">
                        <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">Path to database file/directory</p>
                    </div>
                </div>
                
                <div>
                    <label for="openweatherKey" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">OpenWeather API Key</label>
                    <input type="password" id="openweatherKey" value="<%= config.OPENWEATHER_API_KEY || '' %>"
                           placeholder="Enter API key..."
                           class="input-field">
                    <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">For weather command functionality</p>
                </div>
                
                <div>
                    <label for="openaiKey" class="block text-sm font-medium text-[rgb(var(--color-text-primary))] mb-2">OpenAI API Key</label>
                    <input type="password" id="openaiKey" value="<%= config.OPENAI_API_KEY || '' %>"
                           placeholder="Enter API key..."
                           class="input-field">
                    <p class="text-xs text-[rgb(var(--color-text-secondary))] mt-1">For AI-powered features</p>
                </div>
                
                <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                    <div class="flex items-start space-x-2">
                        <i data-lucide="shield-alert" class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"></i>
                        <div>
                            <p class="font-medium text-red-300 mb-1">Sensitive Information</p>
                            <p class="text-sm text-[rgb(var(--color-text-secondary))]">
                                API keys are sensitive. Never share them publicly and rotate them regularly.
                            </p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    // Toggle pairing number field
    document.getElementById('usePairingCode').addEventListener('change', function() {
        const pairingField = document.getElementById('pairingNumberField');
        pairingField.style.display = this.checked ? 'block' : 'none';
    });
    
    // Check connection status on connection tab
    checkConnectionStatus();
});

function switchTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected content
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-[rgb(var(--color-accent))]', 'text-[rgb(var(--color-accent))]');
        btn.classList.add('border-transparent', 'text-[rgb(var(--color-text-secondary))]');
    });
    
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.add('active', 'border-[rgb(var(--color-accent))]', 'text-[rgb(var(--color-accent))]');
    activeTab.classList.remove('border-transparent', 'text-[rgb(var(--color-text-secondary))]');
    
    lucide.createIcons();
}

async function checkConnectionStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const statusElement = document.getElementById('connectionStatus');
        if (data.success && data.data.isConnected) {
            statusElement.innerHTML = `
                <div class="flex items-center space-x-2 text-green-400">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>Connected</span>
                </div>
            `;
        } else {
            statusElement.innerHTML = `
                <div class="flex items-center space-x-2 text-red-400">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                    <span>Disconnected</span>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('connectionStatus').innerHTML = `
            <div class="flex items-center space-x-2 text-yellow-400">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                <span>Unable to check</span>
            </div>
        `;
    }
    
    lucide.createIcons();
}

async function saveAllSettings() {
    const settings = {
        // General settings
        BOT_NAME: document.getElementById('botName').value,
        PREFIX: document.getElementById('prefix').value,
        LOG_LEVEL: document.getElementById('logLevel').value,
        COMMANDS_DIR: document.getElementById('commandsDir').value,
        AUTO_RECONNECT: document.getElementById('autoReconnect').checked.toString(),
        
        // Connection settings
        PRINT_QR: document.getElementById('printQR').checked.toString(),
        USE_PAIRING_CODE: document.getElementById('usePairingCode').checked.toString(),
        PAIRING_NUMBER: document.getElementById('pairingNumber').value,
        
        // Security settings
        OWNER_NUMBERS: document.getElementById('ownerNumbers').value,
        ADMIN_NUMBERS: document.getElementById('adminNumbers').value,
        
        // Advanced settings
        DB_MODE: document.getElementById('dbMode').value,
        DB_PATH: document.getElementById('dbPath').value,
        OPENWEATHER_API_KEY: document.getElementById('openweatherKey').value,
        OPENAI_API_KEY: document.getElementById('openaiKey').value
    };
    
    try {
        const response = await fetch('/bot/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config: settings })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Settings saved successfully! Some changes may require a bot restart.', 'success');
        } else {
            showToast('Failed to save settings: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Failed to save settings', 'error');
    }
}

async function reloadCommands() {
    try {
        const response = await fetch('/bot/action/reload-plugins', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showToast('Commands reloaded successfully', 'success');
        } else {
            showToast('Failed to reload commands: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Failed to reload commands', 'error');
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    
    const colorClasses = {
        'success': 'bg-green-500 border-green-400',
        'error': 'bg-red-500 border-red-400', 
        'warning': 'bg-yellow-500 border-yellow-400',
        'info': 'bg-blue-500 border-blue-400'
    };
    
    const iconMap = {
        'success': 'check-circle',
        'error': 'x-circle',
        'warning': 'alert-triangle', 
        'info': 'info'
    };
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="flex items-center space-x-3 ${colorClasses[type]} text-white px-4 py-3 rounded-xl shadow-lg border transform translate-x-full transition-transform duration-300">
            <i data-lucide="${iconMap[type]}" class="w-5 h-5 flex-shrink-0"></i>
            <span class="flex-1">${message}</span>
            <button onclick="closeToast('${toastId}')" class="text-white hover:text-gray-200 transition-colors">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    lucide.createIcons();
    
    const toastElement = document.getElementById(toastId);
    setTimeout(() => {
        toastElement.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
        closeToast(toastId);
    }, 8000);
}

function closeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }
}
</script>
